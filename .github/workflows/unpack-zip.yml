name: Unpack ZIP into repo (safe)

on:
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  unpack:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y unzip rsync

      - name: Find ZIP and extract to temp
        id: findzip
        run: |
          set -e
          ZIP="$(ls -1 *.zip 2>/dev/null | head -n1 || true)"
          if [ -z "$ZIP" ]; then
            echo "No ZIP found in repo root."
            exit 1
          fi
          echo "zip=$ZIP" >> $GITHUB_OUTPUT
          rm -rf _unpack
          mkdir -p _unpack
          unzip -q "$ZIP" -d _unpack
          echo "Extracted: $ZIP"

      - name: Determine source dir
        id: srcdir
        run: |
          set -e
          # If the ZIP contains a single top-level folder, use it; otherwise use _unpack itself
          entries=$(find _unpack -mindepth 1 -maxdepth 1 -printf '%f\n' | wc -l)
          if [ "$entries" -eq 1 ] && [ -d "$(find _unpack -mindepth 1 -maxdepth 1 -type d)" ]; then
            SRC="$(find _unpack -mindepth 1 -maxdepth 1 -type d)"
          else
            SRC="_unpack"
          fi
          echo "src=$SRC" >> $GITHUB_OUTPUT
          echo "Using SRC=$SRC"

      - name: Copy project content (exclude .git and .github for now)
        run: |
          set -e
          SRC="${{ steps.srcdir.outputs.src }}"
          rsync -a "$SRC"/ ./ --exclude '.git/' --exclude '.github/'
          echo "Copied project files to repo root."

      - name: Merge .github (skip any workflows from ZIP)
        run: |
          set -e
          SRC="${{ steps.srcdir.outputs.src }}"
          if [ -d "$SRC/.github" ]; then
            mkdir -p .github
            # copy everything in .github except workflows/**
            rsync -a "$SRC/.github/" ./.github/ --exclude 'workflows/**'
            echo "Merged .github (no workflows) from ZIP."
          else
            echo "No .github directory in ZIP; skipping merge."
          fi

      - name: Cleanup ZIP and temp dir
        run: |
          set -e
          rm -f "${{ steps.findzip.outputs.zip }}"
          rm -rf _unpack

      - name: Commit unpacked files
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "Nothing to commit."
          else
            git commit -m "Unpack uploaded ZIP into repository (safe merge, no workflows)"
            git push
          fi
